<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <link rel="stylesheet" href="/css/application.css"/>
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>

    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />

    <title>Map</title>
</head>
<body>
<div class="h-screen w-screen flex flex-col justify-start">
    <div class="bg-white border-b-2 flex flex-col justify-center items-center lg:flex-row lg:justify-between">
        <div class="flex items-center justify-center lg:justify-start">
            <svg class="w-10 inline-block lg:ml-10" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z" clip-rule="evenodd" />
            </svg>
            <a href="/">
                <h1 class="text-4xl p-5 font-body text-gray-900 leading-tight inline-block">City Trip Planner</h1>
            </a>
        </div>
        <a class="text-2xl p-5 font-bold text-gray-900 leading-tight inline-block lg:mr-10
                  cursor-pointer transition duration-500 ease-in-out transform hover:translate-x-4" href="#" th:href="@{/logout}">
            Logout
            <svg class="w-8 inline-block hover" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        </a>
    </div>

    <div class="h-full flex justify-start items-center flex-col lg:flex-row lg:justify-center">

        <div class="w-full h-1/2 p-5 lg:w-1/4 lg:h-full">

            <div class="h-full p-8 bg-white rounded-3xl shadow-2xl flex flex-col items-center justify-start overflow-auto">
                <button class="w-full bg-yellow-400 text-white text-sm py-3 px-5 rounded-lg
                         shadow-lg uppercase tracking-wider font-semibold cursor-pointer sm:text-base hover:bg-yellow-300
                          transition duration-500 ease-in-out transform hover:-translate-y-0.5 hover:scale-105 active:bg-yellow-500"
                        id="test">
                    Test
                </button>

            </div>

        </div>

        <div class="w-full h-1/2 p-5 lg:w-3/4 lg:h-full">
            <div class="h-full rounded-3xl shadow-2xl focus:outline-none" id="map">

            </div>
        </div>

    </div>
</div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2VyZ2VhbnQyMTciLCJhIjoiY2tsdmFyMHE0MGNubzJvbXdlYWk0MXJ2YyJ9.we4if4fwI21YHCqgBURLzQ';
        let map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [27.60, 47.16],
            zoom: 12
        });

        let geoLocate = new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        });

        map.addControl(geoLocate);
        let addedMarkers = [];

        function getPOIDetails(id, name, marker)
        {
            const url = `http://localhost:8080/poi/${id}`;
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                let hoursHTML = ``;
                for(const hours of data.poiHours)
                {
                    hoursHTML += `` +
                        `<div class="">` +
                            `<p class="text-center border-b-2 font-bold text-gray-600">` +
                            `Day: ${hours.dayName ? hours.dayName : "unavailable"}` +
                            `</p>` +
                            `<p class="text-center border-b-2 font-bold text-gray-600">` +
                            `Opening: ${hours.openingAt ? hours.openingAt : "unavailable"}` +
                            `</p>` +
                            `<p class="text-center border-b-2 font-bold text-gray-600">` +
                            `Closing: ${hours.closingAt ? hours.closingAt : "unavailable"}` +
                            `</p>` +
                        `</div>`;
                }

                let html = `` +
                `<p class="mb-2 border-b-2 font-bold text-2xl text-center text-indigo-400">` +
                `${name}` +
                `</p>` +
                    (data.photoPrefix ? `<img class="rounded-2xl shadow-xl" alt="POI Photo" src="${data.photoPrefix}500${data.photoSuffix}">` : "") +
                `<div class="overflow-auto no-scrollbar max-h-40">` +
                    `<p class="mt-4 w-full text-center border-b-2 font-bold text-gray-600">` +
                        `Phone: ${data.formattedPhone ? data.formattedPhone : "unavailable"}` +
                    `</p>` +
                    `<p class="mt-4 w-full text-center border-b-2 font-bold text-gray-600">` +
                        `Rating: ${data.rating ? data.rating : "unavailable"}` +
                    `</p>` +
                    `<p class="mt-4 w-full text-center border-b-2 font-bold text-gray-600">` +
                        `Type: ${data.type ? data.type : "unavailable"}` +
                    `</p>` +
                    `<p class="mt-4 w-full text-center border-b-2 font-bold text-gray-600">` +
                        `Price Tier: ${data.priceTier ? data.priceTier : "unavailable"}` +
                    `</p>` +
                    `${hoursHTML}` +
                `</div>`;

                let popUp = new mapboxgl.Popup().setHTML(html);
                marker.setPopup(popUp);
                marker.togglePopup();
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        function addPOIs(lat, lng, radius)
        {
            const url = `http://localhost:8080/poi?ll=${lat},${lng}&radius=${radius}`;
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    for(const poi of data)
                    {
                        if(!addedMarkers.some(e => e.poi.id === poi.id))
                        {
                            let el = document.createElement('div');
                            el.className = "block rounded-full p-0 border-none cursor-pointer";
                            el.style.backgroundImage = `url(${poi.iconPrefix}bg_` + 32 + `${poi.iconSuffix}`;
                            el.style.width = 32 + 'px';
                            el.style.height = 32 + 'px';

                            let marker = new mapboxgl.Marker(el)
                                .setLngLat([poi.lng, poi.lat])
                                .addTo(map);
                            addedMarkers.push({
                                poi,
                                marker
                            });

                            marker.getElement().addEventListener('click', function() {
                                if(marker.getPopup() == null)
                                {
                                    getPOIDetails(poi.id, poi.name, marker);
                                }
                            });
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        let initialPoint = null;
        let movedPoint = null;

        geoLocate.on('geolocate', function(e) {
            initialPoint = [e.coords.longitude, e.coords.latitude];
        });

        map.on('load', function() {
            initialPoint = [map.getCenter().lng, map.getCenter().lat];

            const lat = map.getCenter().lat;
            const lng = map.getCenter().lng;
            let radiusPoint = [map.getBounds()._ne.lng, map.getBounds()._ne.lat];
            let radius = turf.distance([lng, lat], radiusPoint, {units: 'kilometers'});
            addPOIs(lat, lng, radius / 2);
        });

        map.on('moveend', function() {
            movedPoint = [map.getCenter().lng, map.getCenter().lat];
            let distance = turf.distance(initialPoint, movedPoint, {units: 'kilometers'});

            const lat = map.getCenter().lat;
            const lng = map.getCenter().lng;
            let radiusPoint = [map.getBounds()._ne.lng, map.getBounds()._ne.lat];
            let radius = turf.distance([lng, lat], radiusPoint, {units: 'kilometers'});

            if(map.getZoom() >= 12 && distance >= radius / 4)
            {
                console.log("Loading")
                addPOIs(lat, lng, radius / 2);
                initialPoint = movedPoint;
                console.log(addedMarkers);
            }

        });

    </script>
</body>
</html>